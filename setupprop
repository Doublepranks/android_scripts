#!/bin/bash
# Written by Sean Donovan (swordrune10)

cd $REPOS/$SCRIPT_REPO-ics/out/target/product/$SCRIPT_DEVICE

if [ $SCRIPT_REPO == "cm" ] || [ $SCRIPT_REPO == "sts" ]; then
	zip=$(find cm-*.zip)
fi

if [ $SCRIPT_REPO == "aokp" ]; then
	zip=$(find aokp*.zip)
fi

if [ $SCRIPT_REPO == "evervolv" ]; then
	zip=$(find Evervolv*.zip)
fi

if [ $SCRIPT_REPO == "gummy" ]; then
	zip=$(find Gummy*.zip)
fi

if [ $SCRIPT_REPO == "aosp" ] || [ $SCRIPT_REPO == "rooted-aosp" ]; then
	zip=$(find full*.zip)

	echo "Making temporary folder for post-building $zip fixes"
	mkdir -p $BUILDS/temp/zipout
	cp $zip $BUILDS/temp
	cd $BUILDS/temp/zipout

	echo "Unzipping $zip"
	unzip ../$zip > /dev/null

	echo "Removing uneeded recovery folder from $zip"
	rm -r recovery

	if [ $SCRIPT_REPO == "aosp" ]; then
		cd system
		echo "Adding rom manager items to $zip's build.prop"
		echo "ro.rommanager.developerid=$(whoami)" >> build.prop
		echo "ro.modversion=$(echo "aosp-ics-$(date +%Y%m%d)-$SCRIPT_DEVICE")" >> build.prop

		cd ..
	fi

	echo "Zipping $zip back up"
	zip -r unsignedcrap.zip . > /dev/null

	echo "Signing $zip with test keys"
	java -Xmx1024m -classpath $LOCAL/testsign.jar testsign unsignedcrap.zip $zip
fi

mkdir -p $BUILDS/$SCRIPT_REPO/old

if ( find $BUILDS/$SCRIPT_REPO/*$SCRIPT_DEVICE.zip &> /dev/null); then
	echo "Moving older build to $BUILDS/$SCRIPT_REPO/old"

	mv $BUILDS/$SCRIPT_REPO/*$SCRIPT_DEVICE.zip $BUILDS/$SCRIPT_REPO/old
	mv $BUILDS/$SCRIPT_REPO/*$SCRIPT_DEVICE.zip.md5sum $BUILDS/$SCRIPT_REPO/old
fi

newzip=$(echo $SCRIPT_REPO-ics-$(date +%Y%m%d)-SWORDKITCHEN-$SCRIPT_DEVICE.zip)

echo "Copying to $BUILDS/$SCRIPT_REPO"
echo "$zip -> $newzip"
cp $zip $BUILDS/$SCRIPT_REPO/$newzip

if [ $SCRIPT_REPO == "aosp" ] || [ $SCRIPT_REPO == "rooted-aosp" ]; then
	echo "Cleaning up temporary folder"
	cd $BUILDS
	rm -r temp
fi

cd $BUILDS/$SCRIPT_REPO
md5sum $newzip
md5sum $newzip > $newzip.md5sum
