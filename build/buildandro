#!/bin/bash
# Written by Sean Donovan (swordrune10)

#declare variables
if [ "$OTHER_REPO" ]; then
	repofolder=$( echo "$OTHER_REPO_FOLDER" )
	buildfolder=$( echo "$BUILDS/$OTHER_REPO" )
	newzip=$(echo $OTHER_REPO-$(date +%Y%m%d)-SWORDKITCHEN-$SCRIPT_DEVICE.zip)
elif [ "$AUTO_BUILD" ]; then
	repofolder=$( echo "$REPOS/$AUTO_BUILD_FOLDER" )
	buildfolder=$( echo "$BUILDS/$AUTO_BUILD_FOLDER" )
	newzip=$(echo $AUTO_BUILD_FOLDER-$(date +%Y%m%d)-SWORDKITCHEN-$SCRIPT_DEVICE.zip)
else
	repofolder=$( echo "$REPOS/$SCRIPT_REPO-$REPO_PLATFORM" )
	buildfolder=$( echo "$BUILDS/$SCRIPT_REPO-$REPO_PLATFORM" )
	newzip=$(echo $SCRIPT_REPO-$REPO_PLATFORM-$(date +%Y%m%d)-SWORDKITCHEN-$SCRIPT_DEVICE.zip)
fi

outfolder=$(echo "$repofolder/out/target/product/$SCRIPT_DEVICE")

#setup build
rm -f $outfolder/system/build.prop
rm -f $outfolder/*.zip*

cd $repofolder

. build/envsetup.sh

if [ ! $SLOPPYSECONDS ]; then
	$LOCAL/config/romeditor

	if [ $AUTO ]; then
		make clobber
	else
		echo "clean out folder?"
		read -p "yes/no? " purgeout

		if [ "$purgeout" == "" ]; then
			echo ""
			echo "Did you just hit enter without a care? for that im just gonna clean the folder anyways.."

			make clobber
		fi

		if [ $purgeout == "yes" ] || [ $purgeout == "y" ]; then
			make clobber
		fi
	fi
fi

#build android
if [ $SCRIPT_REPO == "cm" ] || [ $SCRIPT_REPO == "pacman" ] || [ $SCRIPT_REPO == "paranoid" ]; then
	brunch $SCRIPT_DEVICE -j $THREADS_TOTAL
else
	if ( cat vendor/*/vendorsetup.sh | grep $SCRIPT_DEVICE &> /dev/null ); then
		lunch_device=$( cat $( find vendor/*/vendorsetup.sh | sed "/cm\/vendorsetup.sh/d" | head -n 1 ) \
		| grep $SCRIPT_DEVICE | sed 's/add_lunch_combo //' )
	fi

	if [ ! "$lunch_device" ] && ( find device/*/$SCRIPT_DEVICE/vendorsetup.sh &> /dev/null ); then
		lunch_device=$( cat device/*/$SCRIPT_DEVICE/vendorsetup.sh | grep $SCRIPT_DEVICE | sed 's/add_lunch_combo //' )
	fi

	if [ ! "$lunch_device" ]; then
			echo "Repository not supported!"
			read -p "Press Enter to continue: " done
			exit 0
	fi

	lunch $lunch_device
	make otapackage -j $THREADS_TOTAL
fi

#build aftermath
cd $repofolder/out/target/product/$SCRIPT_DEVICE
zip=$(find *$SCRIPT_DEVICE*.zip)

if [ ! "$OTHER_REPO" ] && [ $SCRIPT_REPO == "aosp" ] || [ ! "$OTHER_REPO" ] && [ $SCRIPT_REPO == "raosp" ]; then

	echo "Making temporary folder for post-building $zip fixes"
	mkdir -p $BUILDS/temp/zipout
	cp $zip $BUILDS/temp
	cd $BUILDS/temp/zipout

	echo "Unzipping $zip"
	unzip ../$zip > /dev/null

	echo "Removing uneeded recovery folder and file_contexts from $zip"
	rm -r recovery
	rm file_contexts

	if [ $SCRIPT_REPO == "aosp" ]; then
		cd system
		echo "Adding rom manager items to $zip's build.prop"
		echo "ro.rommanager.developerid=$(whoami)" >> build.prop
		echo "ro.modversion=$newzip >> build.prop

		cd ..
	fi

	cd META-INF/com/google/android
	sed -i "/install-recovery.sh.*/d" updater-script
	cd $BUILDS/temp/zipout
	

	echo "Zipping $zip back up"
	zip -r unsignedcrap.zip . > /dev/null

	echo "Signing $zip with test keys"
	java -Xmx1024m -classpath $LOCAL/testsign.jar testsign unsignedcrap.zip $zip
fi

if ( find $buildfolder/*$SCRIPT_DEVICE.zip &> /dev/null); then
	mkdir -p $buildfolder/old

	echo "Moving older build to $buildfolder/old"

	mv $buildfolder/*$SCRIPT_DEVICE.zip $buildfolder/old
	mv $buildfolder/*$SCRIPT_DEVICE.zip.md5sum $buildfolder/old
fi

mkdir -p $buildfolder

echo "Copying to $buildfolder"
echo "$zip -> $newzip"
cat $zip > $buildfolder/$newzip

if [ ! "$OTHER_REPO" ] && [ $SCRIPT_REPO == "aosp" ] || [ ! "$OTHER_REPO" ] && [ $SCRIPT_REPO == "raosp" ]; then
	echo "Cleaning up temporary folder"
	cd $BUILDS
	rm -r temp
fi

cd $buildfolder
md5sum $newzip
md5sum $newzip > $newzip.md5sum

echo "Finished!"
read -p "Press Enter to continue: " done
