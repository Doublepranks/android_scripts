#!/bin/bash
# Written by Sean Donovan (swordrune10)
clear

if [ "$( cat $LOCAL/config/otherrepo | head -n1 )" == "" ]; then
	echo "other repo file is empty, please add to file then try again!"
	echo "Press Enter to continue"
	read done
	exit 0
fi

echo "EOF" >> $LOCAL/config/otherrepo

while true; do
	let count=$count+1
	filelurker[$count]=$( cat $LOCAL/config/otherrepo | sed -n "$count"p )

	if [ "${filelurker[$count]}" == "EOF" ]; then
		break
	fi
done

sed -i "/EOF/d" $LOCAL/config/otherrepo

menu () {
echo "Swordrune10's Android Kitchen!"
echo "=============================="
echo "Build with other repository is selected to be built!"
echo ""
echo "Which custom android repository are we building from today?"
while true; do
	let countdown=$countdown+1

	echo "  "$countdown". "${filelurker[$countdown]}

	if [ $countdown == $( expr $count - 1 ) ]; then
		break
	fi
done
echo "  $count. Go Back"
read version

if [ "$version" == "" ]; then
	echo ""
	echo "You did not make a proper selection, try again!"
	echo "Press Enter to continue"
	read done
	menu
fi

if ( echo $version | grep -q [A-Za-z] ); then
	echo ""
	echo "You did not make a proper selection, try again!"
	echo "Press Enter to continue"
	read done
	menu
fi

if [ $version -gt $count ]; then
	echo ""
	echo "You did not make a proper selection, try again!"
	echo "Press Enter to continue"
	read done
	menu
fi

if [ $version == $count ]; then
	exit 0
fi

clear

echo ""
echo "What should you name this repo?"
echo "This will serve as naming the build and putting it in a proper folder"
echo "Type in exit to go to back"
read reponame

if [ "$reponame" == "" ]; then
	echo ""
	echo "You did not make a proper selection, try again!"
	echo "Press Enter to continue"
	read done
	menu
fi

if [ $reponame == "exit" ]; then
	exit 0
fi

echo ""
echo "What platform is this repo?"
echo "Examples are; ics, gingerbread, froyo.."
echo "Type in exit to go to back"
read platformname

if [ "$platformname" == "" ]; then
	echo ""
	echo "You did not make a proper selection, try again!"
	echo "Press Enter to continue"
	read done
	menu
fi

if [ $platformname == "exit" ]; then
	exit 0
fi

echo "The selected repo name is "$reponame
echo "The selected platform name is "$platformname
echo ""
echo "Is this correct?"
read answer

if [ "$answer" == "" ]; then
	echo ""
	echo "You did not make a proper selection, try again!"
	echo "Press Enter to continue"
	read done
	menu
fi

if [ $answer == "no" ] || [ $answer == "n" ]; then
	echo ""
	echo "I'm sorry lets try again.."
	echo "Press Enter to continue"
	read done
	menu
fi

export SCRIPT_REPO=$(echo $reponame)
export REPO_PLATFORM=$(echo $platformname)

clear

echo "Swordrune10's Android Kitchen!"
echo "=============================="
echo "Please type in which device you would like to build"
echo "Type in list to see all supported devices"
echo "Type in exit to go back"
read device

if [ "$device" == "" ]; then
	echo ""
	echo "You did not make a proper selection, try again!"
	echo "Press Enter to continue"
	read done
	menu
fi

while [ $device == "list" ]; do
	cd "${filelurker[$version]}"

	while true; do
		let dcount=$dcount+1
		devicefinder[$dcount]=$( . build/envsetup.sh | sed 's/including //g' | sed -n "$dcount"p )

		if ( ! echo "${devicefinder[$dcount]}" | grep -q "device" ) && ( ! echo "${devicefinder[$dcount]}" | grep -q "vendor" ); then
			devicefinder[$dcount]=""
			break
		fi
	done

	sed -e 's/.*_//g' \
	-e 's/-.*//' \
	${devicefinder[*]} | sed "/#.*/d" | sed "/combo.*/d" | sed "/panda.*/d" | sed "/^$/d" | less

	clear

	echo "Swordrune10's Android Kitchen!"
	echo "=============================="
	echo "Please type in which device you would like to build"
	echo "Type in list to see all supported devices"
	echo "Type in exit to go to back"
	read device
done

if [ "$device" == "" ]; then
	echo ""
	echo "You did not make a proper selection, try again!"
	echo "Press Enter to continue"
	read done
	menu
fi

if [ $device == "exit" ]; then
	menu
fi

cd "${filelurker[$version]}"

export OTHER_REPO_FOLDER=$(echo "${filelurker[$version]}")

if ( find device/*/*/vendorsetup.sh &> /dev/null ); then
	export vendor_lunch=$(sed -e 's/add_lunch_combo //g' \
	-e 's/_.*/_/' \
	device/*/*/vendorsetup.sh | sed "/#.*/d" | sed "/combo.*/d" | sed "/panda.*/d" | sed "/^$/d" | head -n 1)
else
	if ( find vendor/*/vendorsetup.sh &> /dev/null ); then
		export vendor_lunch=$(sed -e 's/add_lunch_combo //g' \
		-e 's/_.*/_/' \
		vendor/*/vendorsetup.sh | sed "/#.*/d" | sed "/combo.*/d" | sed "/panda.*/d" | sed "/^$/d" | head -n 1)
	else
		echo "Repository not supported!"
		menu
	fi
fi

clear

setupandro

export SCRIPT_DEVICE=$(echo $device)
buildandro
setupprop

exit 0
}
menu
